def shared_library_branch = scm.branches[0].name
if (shared_library_branch .contains("*/")) {
    shared_library_branch  = shared_library_branch.split("\\*/")[1]
   }
echo shared_library_branch 

library "jenkins-shared@${shared_library_branch}"

def VerifyArgs()
{
    if(params.session_id == '')
    {
      error "Please specify a session_id"
    }
}
pipeline {
  agent { node { label 'mysql' } }
    environment {
      docker_args = "--network host -e TUNA_LOGLEVEL=${tuna_loglevel} -e gateway_ip=${gateway_ip} -e gateway_port=${gateway_port} -e gateway_user=${gateway_user} --privileged --device=/dev/kfd --device /dev/dri:/dev/dri:rw --volume /dev/dri:/dev/dri:rw --group-add video"
      partition = "${arch_id}"
      tuna_docker_name = utils.getDockerName("HIP")
      arch_id = "${params.arch}_${params.num_cu}"
  }
  parameters {
    string(name: 'branch_name', defaultValue: 'eval_pipe', description: '')
    choice(name: 'use_mlir', choices: ['On', 'Off'], description: 'Build MIOpen with MLIR enabled')
    booleanParam(name: 'dynamic_solvers_only', defaultValue: false, description: 'Only use dynamic solvers in tuning')
    string(name: 'session_id', defaultValue: '', description: 'session id for evaluation')
    choice(name: 'tuna_loglevel', choices: ['WARN', 'ERROR', 'INFO'], description: 'Log level for TUNA')
    string(name: 'env', defaultValue: '', description: 'Additional environment variables for compilation.')
    string(name: 'db_host', defaultValue: "${headnode}", description: 'Name of the machine hosting the database instance')
    string(name: 'db_name', defaultValue: "${PIPELINE_DB_NAME}", description: 'Name of the database schema')
    string(name: 'db_user', defaultValue: "${PIPELINE_USER}", description: 'Username for the databse')
    string(name: 'db_password', defaultValue: "${PIPELINE_PWD}", description: 'Password for the user')
    string(name: 'docker_registry', defaultValue: "${headnode}:5000", description: 'Name of the docker registry for pushing images')
    string(name: 'base_image', defaultValue: '', description: 'Put a fully qualified docker name here to use (optional)')
    choice(name: 'stage', choices: ['perf', 'fin_find'], description: 'Evaluate method')
  }
  stages {
    stage("Check params")
    {
      steps {
          VerifyArgs()   
      }
    }
    stage('evaluate')
    {
      steps {
        script {
          utils.evaluate(params)
        }
      }
    }
  }
  post {
    always {
      script {
          echo "clean up container"
          utils.killContainer()
      }
    }
  }
}



